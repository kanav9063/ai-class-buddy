"use strict";(()=>{var e={};e.id=744,e.ids=[744],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},3457:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>q,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>x});var r={};s.r(r),s.d(r,{POST:()=>h});var n=s(9303),o=s(8716),a=s(670),i=s(7070),u=s(4214),d=s(4672),c=s(2303),p=s(4673);let l=new u.ZP({apiKey:process.env.OPENAI_API_KEY});async function h(e){try{let{sessionId:t,message:s}=await e.json();if(!t||!s)return i.NextResponse.json({error:"Missing sessionId or message"},{status:400});let r=d.h.getSession(t);if(!r)return i.NextResponse.json({error:"Session not found"},{status:404});let n={id:(0,p.Z)(),sessionId:t,role:"user",content:s,createdAt:Date.now()};d.h.addChatMessage(t,n);let o=await (0,c.OC)(s),a=[...r.transcriptSegments.filter(e=>e.embedding).map(e=>{var t;return{text:`[${t=e.timestamp,`${Math.floor(t/60).toString().padStart(2,"0")}:${Math.floor(t%60).toString().padStart(2,"0")}`}] ${e.text}`,embedding:e.embedding,source:"transcript"}}),...r.noteChunks.map(e=>({text:e.text,embedding:e.embedding,source:"notes"}))],u=(0,c._B)(o,a,6).map(e=>`[${e.source.toUpperCase()}] ${e.text}`).join("\n\n---\n\n"),h=r.chatMessages.slice(-10).map(e=>({role:e.role,content:e.content})),m=await l.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:`You are an AI study assistant helping a student during a live lecture. You have access to the live transcript and uploaded lecture notes. Answer questions based on this context. Be concise and helpful. If the context doesn't contain enough information, say so.

CONTEXT:
${u}`},...h],temperature:.3,max_tokens:1e3}),g=m.choices[0]?.message?.content||"Sorry, I couldn't generate a response.",x={id:(0,p.Z)(),sessionId:t,role:"assistant",content:g,createdAt:Date.now()};return d.h.addChatMessage(t,x),i.NextResponse.json({id:x.id,role:"assistant",content:g})}catch(t){let e=t instanceof Error?t.message:"Chat failed";return console.error("Chat error:",e),i.NextResponse.json({error:e},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"/home/ubuntu/.openclaw/workspace-codegen/ai-class-buddy/src/app/api/chat/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:f}=m,q="/api/chat/route";function b(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:x})}},2303:(e,t,s)=>{s.d(t,{OC:()=>n,S1:()=>o,_B:()=>a,kZ:()=>i});let r=new(s(4214)).ZP({apiKey:process.env.OPENAI_API_KEY});async function n(e){return(await r.embeddings.create({model:"text-embedding-3-small",input:e})).data[0].embedding}async function o(e){return 0===e.length?[]:(await r.embeddings.create({model:"text-embedding-3-small",input:e})).data.map(e=>e.embedding)}function a(e,t,s=5){let r=t.map(t=>({text:t.text,score:function(e,t){let s=0,r=0,n=0;for(let o=0;o<e.length;o++)s+=e[o]*t[o],r+=e[o]*e[o],n+=t[o]*t[o];return s/(Math.sqrt(r)*Math.sqrt(n)+1e-10)}(e,t.embedding),source:t.source}));return r.sort((e,t)=>t.score-e.score),r.slice(0,s)}function i(e,t=500,s=50){let r=e.split(/\s+/),n=[];for(let e=0;e<r.length;e+=t-s){let s=r.slice(e,e+t).join(" ");s.trim()&&n.push(s.trim())}return n}},4672:(e,t,s)=>{s.d(t,{h:()=>o});class r{createSession(e,t,s){let r={id:e,name:t,className:s,createdAt:Date.now(),isRecording:!1,transcriptSegments:[],noteChunks:[],chatMessages:[]};return this.sessions.set(e,r),r}getSession(e){return this.sessions.get(e)}getAllSessions(){return Array.from(this.sessions.values()).sort((e,t)=>t.createdAt-e.createdAt)}addTranscript(e,t){let s=this.sessions.get(e);s&&s.transcriptSegments.push(t)}addNoteChunks(e,t){let s=this.sessions.get(e);s&&s.noteChunks.push(...t)}addChatMessage(e,t){let s=this.sessions.get(e);s&&s.chatMessages.push(t)}deleteSession(e){this.sessions.delete(e)}constructor(){this.sessions=new Map}}let n=globalThis;n.__store||(n.__store=new r);let o=n.__store}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[276,972,425],()=>s(3457));module.exports=r})();